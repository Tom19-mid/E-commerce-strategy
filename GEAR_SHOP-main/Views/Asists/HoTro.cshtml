@{
	ViewData["Title"] = "Hỗ trợ trực tuyến";
	Layout = "~/Views/Shared/_Layout_4TL.cshtml";
}


<!-- CSS -->
<link href="~/css/shop.css" rel="stylesheet">
<link rel="stylesheet" href="~/css/mega-menu.css" />


<!-- Fonts & Icons -->
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
<!-- JS LIBRARIES -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
<script src="~/js/main.js"></script>

<!-- Libraries Stylesheet -->
<link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">

<!-- Customized Bootstrap Stylesheet -->
<link href="~/css/style.css" rel="stylesheet">

<!-- CSS -->
<link href="~/css/shop.css" rel="stylesheet">
<link rel="stylesheet" href="~/css/mega-menu.css" />



<!--Thanh chat-->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" />
<script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">

<!-- [ADD] Google Font có tiếng Việt -->
<link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<style>
    :root {
        --app-font: "Be Vietnam Pro", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif;
    }

    .checkout, .order-summary, .payment, .card, .form-control, .custom-select, .btn {
        font-family: var(--app-font) !important;
    }
</style>

<style>
    /* 🔔 Chấm đỏ thông báo tin nhắn mới */
    /* .alert-dot {
                position: absolute;
                top: -6px;
                right: 6px;
                width: 20px;
                height: 20px;
                background: #ff3b30;
                border-radius: 50%;
                display: none;
                box-shadow: 0 0 0 3px rgba(255, 59, 48, 0.2);
            }

                .alert-dot.visible {
                    display: inline-block;
                } */
    /* 🔔 Badge hiển thị số tin nhắn chưa đọc */
    
    /* Container */
    .chat-container {
        width: 100%;
        max-width: 900px;
        margin: 40px auto;
        border: 1px solid #ddd;
        border-radius: 10px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        height: 70vh;
        background: #f8f9fa;
        font-family: "Be Vietnam Pro", sans-serif;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    /* Body */
    .chat-body {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    .msg {
        max-width: 70%;
        padding: 10px 14px;
        border-radius: 12px;
        line-height: 1.4;
        word-wrap: break-word;
    }

        .msg.customer {
            background: #DCF8C6;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }

        .msg.admin {
            background: #fff;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }

    .chat-header {
        background-color: #D19C97;
        color: white;
        padding: 15px;
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.1rem;
        border-top-left-radius: 10px;
        border-top-right-radius: 10px;
        font-weight: bold;
    }


    .chat-messages {
        padding: 10px;
        height: 0;
        overflow-y: auto;
        font-size: 0.9em;
    }

    .chat-input {
        display: flex;
        align-items: flex-end;
        padding: 6px;
        border-top: 1px solid #ccc;
        border-radius: 10px;
        background-color: #fff;
        gap: 6px;
    }

        .chat-input textarea {
            flex: 1;
            border: 1px solid #ccc;
            border-radius: 10px;
            padding: 8px 10px;
            font-family: Tahoma;
            font-size: 14px;
            line-height: 1.4;
            resize: none; /* không cho kéo thủ công */
            overflow-y: auto;
            outline: none;
            height: 36px;
            max-height: 120px;
            white-space: pre-wrap; /* xuống dòng tự nhiên */
            word-wrap: break-word; /* tự động ngắt từ */
        }

        .chat-input button {
            background-color: #D19C97;
            color: white;
            border-radius: 10px;
            padding: 8px 10px;
            cursor: pointer;
            border: none;
            transition: background 0.2s;
        }

            .chat-input button:hover {
                background-color: #b67d78;
            }

    .chat-input-right {
        position: relative;
        display: flex;
        justify-content: flex-end; /* căn phải */
        padding: 12px;
        border-top: 1px solid #eee;
    }

    .input-wrapper {
        display: flex;
        gap: 10px;
    }

    .chat-input-right input {
        width: 300px; /* độ rộng input */
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 12px;
        font-size: 14px;
    }

        .chat-input-right input:focus {
            border-color: #0078d4;
            outline: none;
        }

    .chat-input-right button {
        padding: 12px 18px;
        background-color: #0078d4;
        color: white;
        border: none;
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.2s;
    }

        .chat-input-right button:hover {
            background-color: #005fa3;
        }


    .message-wrapper {
        display: flex;
    }

        .message-wrapper.admin {
            justify-content: flex-start; /* Admin bên trái */
            margin-bottom: 3px;
        }

        .message-wrapper.customer {
            justify-content: flex-end; /* Khách bên phải */
            margin-bottom: 3px;
        }

    .message-bubble {
        padding: 6px 10px;
        border-radius: 8px;
        max-width: 70%;
        word-wrap: break-word; /* xuống hàng khi quá dài */
        white-space: pre-wrap; /* giữ khoảng trắng và xuống hàng theo nội dung */
    }

        .message-bubble.admin {
            background-color: #e1ffc7;
        }

        .message-bubble.customer {
            background-color: #c7d8ff;
        }

        .message-bubble .time {
            font-size: 10px;
            color: #666;
            text-align: right;
            margin-top: 4px;
        }

    /* Emoji picker */
    .emoji-picker {
        display: none;
        position: absolute;
        bottom: 25px;
        right: 350px; /* đặt bên phải */
        width: 220px;
        max-height: 200px;
        overflow-y: auto;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 5px;
        flex-wrap: wrap;
        gap: 5px;
        z-index: 10;
    }

        .emoji-picker span {
            cursor: pointer;
            font-size: 20px;
            padding: 5px;
            border-radius: 4px;
            transition: background 0.2s;
        }

            .emoji-picker span:hover {
                background: #f1f1f1;
            }

}

</style>
<!-- Khung chat -->
<div id="chatBox" class="chat-container">
    <div class="chat-header" style="font-family: Tahoma;">
        <i class="fas fa-comments"></i> Chat với admin
    </div>
    <div id="messagesList" class="chat-body"></div>
    <div class="chat-main">
        <div id="messagesList" class="chat-messages"></div>
        <div id="inputArea" class="chat-input">
            <textarea id="messageInput" placeholder="Nhập tin nhắn..." rows="1"></textarea>
            <button id="emojiButton" class="emoji-btn">😀</button>
            <button id="sendButton"><i class="fa-solid fa-paper-plane"></i> Gửi</button>
            <div id="emojiPicker" class="emoji-picker"></div>
        </div>
    </div>
</div>


 <!-- SignalR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/7.0.5/signalr.min.js"></script>
    <script>
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .build();

        let lastDate = ""; // lưu ngày của tin nhắn trước đó

        function formatDateTime() {
            const now = new Date();
            const date = now.toLocaleDateString(); // dd/mm/yyyy
            const time = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}); // hh:mm
            return { date, time };
        }

        connection.on("ReceiveMessage", function (user, message) {
            const msgWrapper = document.createElement("div");
           msgWrapper.className = `message-wrapper ${user === "Admin" ? "admin" : "customer"}`;

            const { date, time } = formatDateTime();

            // Chỉ hiển thị ngày nếu khác ngày trước đó
        if (date !== lastDate) {
            const dateDiv = document.createElement("div");
            dateDiv.textContent = date;
            dateDiv.style.fontSize = "12px";
            dateDiv.style.color = "#888";
            dateDiv.style.textAlign = "center";
            dateDiv.style.margin = "10px 0"; // tạo khoảng cách trên và dưới
            dateDiv.style.width = "100%"; // chiếm hết chiều rộng

            document.getElementById("messagesList").appendChild(dateDiv); // thêm trực tiếp vào messagesList
            lastDate = date;
        }

            const msgDiv = document.createElement("div");
            msgDiv.className = `message-bubble ${user === "Admin" ? "admin" : "customer"}`;
            msgDiv.innerHTML = `<strong>${user}</strong>: ${message}`;

            const timeDiv = document.createElement("div");
            timeDiv.className = "time";
            timeDiv.textContent = time;

            msgDiv.appendChild(timeDiv);
            msgWrapper.appendChild(msgDiv);
            document.getElementById("messagesList").appendChild(msgWrapper);

            const messagesList = document.getElementById("messagesList");
            messagesList.scrollTop = messagesList.scrollHeight;
        });

        connection.start().catch(err => console.error(err));

        function sendMessage() {
            const input = document.getElementById("messageInput");
            const message = input.value.trim();
            if (message) {
                connection.invoke("SendMessage", "Khách", message).catch(err => console.error(err));
                input.value = "";
            }
        }

        document.getElementById("sendButton").addEventListener("click", sendMessage);
        document.getElementById("messageInput").addEventListener("keydown", function (e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });


        const emojiButton = document.getElementById("emojiButton");
        const emojiPicker = document.getElementById("emojiPicker");
        const messageInput = document.getElementById("messageInput");
        const emojis = ["😀","😂","😍","😎","😭","😡","👍","🙏","🎉","💖"];
        emojis.forEach(e => {
            const span = document.createElement("span");
            span.textContent = e;
            span.addEventListener("click", () => {
                messageInput.value += e;
                emojiPicker.style.display = "none";
                messageInput.focus();
            });
            emojiPicker.appendChild(span);
        });


        emojiButton.addEventListener("click", () => {
            emojiPicker.style.display = emojiPicker.style.display === "flex" ? "none" : "flex";
        });

        // Đóng emoji picker khi click ra ngoài
        document.addEventListener("click", (e) => {
            const isClickInside = emojiPicker.contains(e.target) || emojiButton.contains(e.target);
            if (!isClickInside) {
                emojiPicker.style.display = "none";
            }
        });


        document.getElementById("chatBar").addEventListener("click", function () {
            document.getElementById("chatBox").style.display = "flex";
            document.getElementById("chatBar").style.display = "none";
        });

        document.getElementById("minimizeButton").addEventListener("click", function () {
            document.getElementById("chatBox").style.display = "none";
            document.getElementById("chatBar").style.display = "block";
        });

                // === THÔNG BÁO TIN NHẮN MỚI (hiển thị số lượng) ===
        let unreadCount = 0;

               // Tạo badge hiển thị số tin nhắn chưa đọc (nếu chưa có)
        if (!document.getElementById("newMessageAlert")) {
            const alertBadge = document.createElement("div");
            alertBadge.id = "newMessageAlert";
            document.getElementById("chatBar").style.position = "relative";
            document.getElementById("chatBar").appendChild(alertBadge);
        }

               // === THÔNG BÁO TIN NHẮN MỚI (cập nhật: chỉ hiển thị 1 thông báo duy nhất) ===

        // Xin quyền gửi thông báo trình duyệt (chỉ hỏi 1 lần)
        if ("Notification" in window && Notification.permission !== "granted") {
            Notification.requestPermission();
        }

        // Tạo hoặc cập nhật badge đếm tin nhắn chưa đọc
        function updateBadge() {
            const alertDot = document.getElementById("newMessageAlert");
            let count = parseInt(alertDot.textContent || "0", 10);
            count++;
            alertDot.textContent = count;
            alertDot.style.display = "flex";
        }

        // Phát âm thanh thông báo
        const notifySound = new Audio("/sounds/notify.mp3");
        notifySound.preload = "auto";
        function playNotifySound() {
            try {
                notifySound.currentTime = 0;
                notifySound.play();
            } catch (e) {}
        }

        // Lắng nghe sự kiện từ SignalR
        connection.on("ReceiveMessage", function (user, message) {
            const chatBox = document.getElementById("chatBox");
            const alertDot = document.getElementById("newMessageAlert");

            // Nếu khung chat đang ẩn => hiển thị số tin nhắn và thông báo
            if (chatBox.style.display === "none" || chatBox.style.display === "") {
                updateBadge();
                playNotifySound();

                // Hiển thị thông báo trình duyệt — dùng tag để thay thế cái cũ
                if (Notification.permission === "granted") {
                    new Notification("Tin nhắn mới 💬", {
                        body: `${user}: ${message}`,
                        tag: "chat-message",   // 👉 Tất cả noti cùng tag này sẽ thay thế nhau
                        renotify: true,        // 👉 Cho phép thay thế thông báo cũ
                        icon: "/images/chat-icon.png"
                    });
                }
            }
        });
    </script>