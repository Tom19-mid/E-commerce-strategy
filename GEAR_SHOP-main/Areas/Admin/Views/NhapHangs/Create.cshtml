@model TL4_SHOP.Models.ViewModels.NhapHangCreateViewModel
@{
    ViewData["Title"] = "Tạo phiếu nhập";
    Layout = "~/Areas/Admin/Views/Shared/_Admin_Layout.cshtml";
    var suppliers = (IEnumerable<TL4_SHOP.Data.NhaCungCap>)ViewBag.Suppliers;
    var products = (IEnumerable<dynamic>)ViewBag.Products;
}
<h4 class="mb-3">Tạo phiếu nhập</h4>

<form asp-action="Create" method="post">
    @Html.AntiForgeryToken()
    <div class="card mb-3">
        <div class="card-body row g-3">
            <div class="col-md-4">
                <label class="form-label">Nhà cung cấp</label>
                <select class="form-select" asp-for="NhaCungCapId">
                    <option value="">-- Chọn --</option>
                    @foreach (var s in suppliers)
                    {
                        <option value="@s.NhaCungCapId">@s.TenNhaCungCap</option>
                    }
                </select>
                <span asp-validation-for="NhaCungCapId" class="text-danger"></span>
            </div>
            <div class="col-md-3">
                <label class="form-label">Ngày nhập</label>
                <input asp-for="NgayNhap" type="datetime-local" class="form-control" value="@DateTime.Now.ToString("yyyy-MM-ddTHH:mm")" />
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <div class="d-flex align-items-center justify-content-between mb-2">
                <h6 class="mb-0">Chi tiết</h6>
                <button type="button" class="btn btn-outline-primary btn-sm" id="btnAdd">+ Thêm dòng</button>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered align-middle">
                    <thead><tr><th style="width:40%">Sản phẩm</th><th style="width:15%">Số lượng</th><th style="width:20%">Đơn giá nhập</th><th style="width:10%"></th></tr></thead>
                    <tbody id="tbody">
                        @for (int i = 0; i < Model.Items.Count; i++)
                        {
                            <tr>
                                <td>
                                    <select name="Items[@i].SanPhamId" class="form-select">
                                        <option value="">-- Chọn sản phẩm --</option>
                                        @foreach (var p in products)
                                        {
                                            <option value="@p.SanPhamId">@p.TenSanPham</option>
                                        }
                                    </select>
                                </td>
                                <td><input type="number" name="Items[@i].SoLuong" class="form-control" value="1" min="1" /></td>
                                <td>
                                    <input class="form-control" data-money inputmode="numeric"
                                           name="Items[@i].DonGiaNhap" value="@(Model.Items[i].DonGiaNhap)" />
                                </td>
                                <td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger btn-remove">X</button></td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="mt-3 d-flex gap-2">
        <a asp-action="Index" class="btn btn-outline-secondary">Huỷ</a>
        <button type="submit" class="btn btn-primary">Lưu phiếu nhập</button>
    </div>
</form>

<template id="rowTemplate">
    <tr>
        <td>
            <select name="__name__.SanPhamId" class="form-select">
                <option value="">-- Chọn sản phẩm --</option>
                @foreach (var p in products)
                {
                    <option value="@p.SanPhamId">@p.TenSanPham</option>
                }
            </select>
        </td>
        <td><input type="number" name="__name__.SoLuong" class="form-control" value="1" min="1" /></td>
        <td>
            <input class="form-control" data-money inputmode="numeric"
                   name="__name__.DonGiaNhap" value="0" />
        </td>
        <td class="text-center"><button type="button" class="btn btn-sm btn-outline-danger btn-remove">X</button></td>
    </tr>
</template>

@section Scripts {
    <script>
        (function(){
          let tbody = document.getElementById('tbody');
          let btnAdd = document.getElementById('btnAdd');
          function reindex() {
              [...tbody.querySelectorAll('tr')].forEach((tr, idx) => {
                  tr.querySelectorAll('select, input').forEach((el) => {
                      el.name = el.name.replace(/Items\[\d+\]/, `Items[${idx}]`);
                  });
              });
          }
                  btnAdd.addEventListener('click', function(){
            let tmpl = document.getElementById('rowTemplate').innerHTML;
            let nextIndex = tbody.querySelectorAll('tr').length;
            tmpl = tmpl.replaceAll('__name__', `Items[${nextIndex}]`);
            tbody.insertAdjacentHTML('beforeend', tmpl);

            // Khởi tạo formatter cho các <input data-money> vừa thêm
            const newRow = tbody.lastElementChild;
            if (window.moneyFormatInit) window.moneyFormatInit(newRow);
        });
          document.addEventListener('click', function(e){
              if (e.target.classList.contains('btn-remove')) { e.target.closest('tr').remove(); reindex(); }
          });
        })();
    </script>
}
