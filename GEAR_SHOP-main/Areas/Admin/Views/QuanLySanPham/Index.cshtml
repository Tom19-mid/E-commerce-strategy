@model IEnumerable<TL4_SHOP.Models.ViewModels.ProductListItemVM>
@{
    ViewData["Title"] = "Quản lý sản phẩm";
    Layout = "~/Areas/Admin/Views/Shared/_Admin_Layout.cshtml";
    var filter = (TL4_SHOP.Models.ViewModels.ProductFilterVM)ViewBag.Filter;
    var backUrl = Context.Request.Path + Context.Request.QueryString;
    int total = (int)ViewBag.Total;
    int pageCount = (int)Math.Ceiling(total / (double)filter.PageSize);
}

@using Microsoft.AspNetCore.Mvc.Rendering
@{
    // Tạo SelectList có sẵn giá trị được chọn
    var dmSelect = new SelectList((IEnumerable<dynamic>)ViewBag.DanhMucs, "DanhMucId", "TenDanhMuc", filter.DanhMucID);
    var nccSelect = new SelectList((IEnumerable<dynamic>)ViewBag.NhaCungCaps, "NhaCungCapId", "TenNhaCungCap", filter.NhaCungCapID);

    // SelectList cho LaNoiBat (null/true/false)
    var featuredSelect = new SelectList(new[]
    {
        new { Value = (bool?)null,  Text = "-- Nổi bật? --" },
        new { Value = (bool?)true,  Text = "Có" },
        new { Value = (bool?)false, Text = "Không" }
    }, "Value", "Text", filter.LaNoiBat);
}

<div class="d-flex align-items-center justify-content-between mb-3">
  <h4 class="mb-0">Sản phẩm</h4>
    <a class="btn btn-primary"
       asp-action="Create"
       asp-route-q="@filter.q"
       asp-route-DanhMucID="@filter.DanhMucID"
       asp-route-NhaCungCapID="@filter.NhaCungCapID"
       asp-route-LaNoiBat="@filter.LaNoiBat"
       asp-route-Page="@filter.Page"
       asp-route-PageSize="@filter.PageSize">+ Thêm sản phẩm</a>
</div>

<form method="get" class="card mb-3">
  <div class="card-body row g-2">
    <div class="col-md-3"><input name="q" value="@filter.q" class="form-control" placeholder="Tìm tên sản phẩm..." /></div>
    <div class="col-md-3">
            <select name="DanhMucID" class="form-select" asp-items="dmSelect">
                <option value="">-- Tất cả danh mục --</option>
            </select>
    </div>
    <div class="col-md-3">
            <select name="NhaCungCapID" class="form-select" asp-items="nccSelect">
                <option value="">-- Tất cả nhà cung cấp --</option>
            </select>
    </div>
    <div class="col-md-2">
            <select name="LaNoiBat" class="form-select" asp-items="featuredSelect"></select>
    </div>
    <div class="col-md-1">
      <button class="btn btn-secondary w-100">Lọc</button>
    </div>
  </div>
</form>

<div class="card">
  <div class="table-responsive">
    <table class="table align-middle mb-0">
      <thead>
        <tr>
          <th>Ảnh</th>
          <th>Tên</th>
          <th>Danh mục</th>
          <th>Nhà cung cấp</th>
          <th class="text-end">Giá</th>
          <th class="text-end">Giá giảm</th>
          <th class="text-end">Tồn</th>
          <th class="text-center">Nổi bật</th>
          <th style="width:160px"></th>
        </tr>
      </thead>
      <tbody>
      @foreach (var p in Model)
      {
        <tr>
          <td>
            @if (!string.IsNullOrEmpty(p.HinhAnh))
            { <img src="~/@p.HinhAnh" style="height:48px;border-radius:8px;border:1px solid #eee" /> }
          </td>
          <td>
            <div class="fw-semibold">@p.TenSanPham</div>
          </td>
          <td>@p.TenDanhMuc</td>
          <td>@p.TenNhaCungCap</td>
          <td class="text-end">@p.Gia.ToString("#,0 đ")</td>
          <td class="text-end">@((p.GiaSauGiam ?? 0).ToString("#,0 đ"))</td>
          <td class="text-end">@p.SoLuongTon</td>
                        <td class="text-center">
                            <form asp-action="ToggleFeatured" method="post" class="d-inline"
                                  asp-route-q="@filter.q"
                                  asp-route-DanhMucID="@filter.DanhMucID"
                                  asp-route-NhaCungCapID="@filter.NhaCungCapID"
                                  asp-route-LaNoiBat="@filter.LaNoiBat"
                                  asp-route-Page="@filter.Page"
                                  asp-route-PageSize="@filter.PageSize">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@p.SanPhamID" />
                                <button class="btn btn-sm @(p.LaNoiBat==true ? "btn-success" : "btn-outline-secondary")">
                                    @(p.LaNoiBat == true ? "Có" : "Không")
                                </button>
                            </form>
                        </td>
                        <td class="text-end">
                            <a class="btn btn-sm btn-primary"
                               asp-action="Edit"
                               asp-route-id="@p.SanPhamID"
                               asp-route-returnUrl="@backUrl">Sửa</a>

                            <form asp-action="Delete" method="post" class="d-inline js-confirm" data-confirm="Xoá sản phẩm này?"
                                  asp-route-q="@filter.q"
                                  asp-route-DanhMucID="@filter.DanhMucID"
                                  asp-route-NhaCungCapID="@filter.NhaCungCapID"
                                  asp-route-LaNoiBat="@filter.LaNoiBat"
                                  asp-route-Page="@filter.Page"
                                  asp-route-PageSize="@filter.PageSize">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@p.SanPhamID" />
                                <button class="btn btn-sm btn-danger">Xoá</button>
                            </form>
                        </td>
        </tr>
      }
      </tbody>
    </table>
  </div>

  <div class="card-footer d-flex justify-content-between align-items-center">
    <div>Tổng: <strong>@total</strong> sản phẩm</div>
    <nav>
      <ul class="pagination mb-0">
        @for (int i = 1; i <= pageCount; i++)
        {
            <li class="page-item @(i==filter.Page?"active":"")">
              <a class="page-link" href="@Url.Action("Index", new { q=filter.q, DanhMucID=filter.DanhMucID, NhaCungCapID=filter.NhaCungCapID, LaNoiBat=filter.LaNoiBat, Page=i, PageSize=filter.PageSize })">@i</a>
            </li>
        }
      </ul>
    </nav>
  </div>
</div>
